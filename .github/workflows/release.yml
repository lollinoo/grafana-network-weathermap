name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Release Plugin
    runs-on: ubuntu-latest
    env:
      GRAFANA_API_KEY: ${{ secrets.GRAFANA_API_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run CI verification
        run: npm run verify:ci

      - name: Sign plugin
        if: ${{ env.GRAFANA_API_KEY != '' }}
        run: npm run sign

      - name: Read plugin metadata
        id: metadata
        run: |
          PLUGIN_ID="$(jq -r '.id' dist/plugin.json)"
          PLUGIN_VERSION="$(jq -r '.info.version' dist/plugin.json)"
          PLUGIN_TYPE="$(jq -r '.type' dist/plugin.json)"
          ARCHIVE="${PLUGIN_ID}-${PLUGIN_VERSION}.zip"
          CHECKSUM="${ARCHIVE}.sha256"

          echo "plugin_id=${PLUGIN_ID}" >> "${GITHUB_OUTPUT}"
          echo "plugin_version=${PLUGIN_VERSION}" >> "${GITHUB_OUTPUT}"
          echo "plugin_type=${PLUGIN_TYPE}" >> "${GITHUB_OUTPUT}"
          echo "archive=${ARCHIVE}" >> "${GITHUB_OUTPUT}"
          echo "checksum_file=${CHECKSUM}" >> "${GITHUB_OUTPUT}"

      - name: Check tag and package version match
        run: |
          if [ "v${{ steps.metadata.outputs.plugin_version }}" != "${GITHUB_REF_NAME}" ]; then
            echo "Plugin version does not match git tag"
            exit 1
          fi

      - name: Read changelog section
        run: |
          awk '/^## / {s++} s == 1 {print}' CHANGELOG.md > release_notes.md

      - name: Package plugin
        id: package
        run: |
          mv dist "${{ steps.metadata.outputs.plugin_id }}"
          zip -r "${{ steps.metadata.outputs.archive }}" "${{ steps.metadata.outputs.plugin_id }}"
          sha256sum "${{ steps.metadata.outputs.archive }}" > "${{ steps.metadata.outputs.checksum_file }}"
          CHECKSUM="$(cut -d' ' -f1 "${{ steps.metadata.outputs.checksum_file }}")"
          echo "checksum=${CHECKSUM}" >> "${GITHUB_OUTPUT}"

      - name: Create GitHub release draft
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body_path: release_notes.md
          draft: true
          files: |
            ${{ steps.metadata.outputs.archive }}
            ${{ steps.metadata.outputs.checksum_file }}

      - name: Print release metadata
        run: |
          echo "{ \"id\": \"${{ steps.metadata.outputs.plugin_id }}\", \"type\": \"${{ steps.metadata.outputs.plugin_type }}\", \"version\": \"${{ steps.metadata.outputs.plugin_version }}\", \"checksum\": \"${{ steps.package.outputs.checksum }}\" }"
